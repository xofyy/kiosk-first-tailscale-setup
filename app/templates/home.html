{% extends "base.html" %}

{% block title %}Home - ACO Maintenance Panel{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- System Control -->
    <div class="system-controls">
        <button class="btn btn-power btn-reboot" onclick="systemReboot()">
            <span class="btn-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M1 4v6h6M23 20v-6h-6"/>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                </svg>
            </span>
            Reboot
        </button>
        <button class="btn btn-power btn-shutdown" onclick="systemShutdown()">
            <span class="btn-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/>
                    <line x1="12" y1="2" x2="12" y2="12"/>
                </svg>
            </span>
            Shutdown
        </button>
    </div>

    <!-- RVM ID Section -->
    <section class="section rvm-section">
        <h2 class="section-title" data-icon="config">RVM Identity</h2>

        {% if rvm_id %}
        <!-- Display Mode -->
        <div class="rvm-id-display" id="rvm-id-display">
            <span class="rvm-id-label">RVM ID:</span>
            <span class="rvm-id-value" id="rvm-id-value">{{ rvm_id }}</span>
            {% if not tailscale_completed %}
            <button class="btn btn-icon btn-sm" onclick="toggleRvmIdEdit(true)" title="Edit RVM ID">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </button>
            {% endif %}
        </div>

        {% if not tailscale_completed %}
        <!-- Edit Mode (hidden by default) -->
        <div class="rvm-id-panel rvm-id-edit" id="rvm-id-edit" style="display: none;">
            <form id="rvm-id-edit-form" class="rvm-id-form">
                <div class="form-group">
                    <input type="text" name="rvm_id" class="form-control"
                           value="{{ rvm_id }}" pattern="[A-Z0-9_-]+"
                           title="Only uppercase letters, numbers, hyphens and underscores">
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Save</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleRvmIdEdit(false)">Cancel</button>
            </form>
        </div>
        {% endif %}
        {% else %}
        <div class="rvm-id-panel">
            <p class="text-muted">You must set RVM ID before starting installation.</p>

            <form id="rvm-id-form" class="rvm-id-form">
                <div class="form-group">
                    <input type="text" name="rvm_id" class="form-control form-control-lg"
                           placeholder="RVM-001" pattern="[A-Z0-9_-]+"
                           title="Only uppercase letters, numbers, hyphens and underscores">
                    <small class="text-muted">Example: RVM-001, BRANCH-NYC-01</small>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
        {% endif %}
    </section>

    <!-- System Info -->
    <section class="section system-info-section">
        <h2 class="section-title" data-icon="system">System Information</h2>
        <div class="system-info-grid">
            <div class="system-info-item">
                <span class="system-info-label">Hostname</span>
                <span class="system-info-value">{{ system_info.hostname }}</span>
            </div>
            <div class="system-info-item">
                <span class="system-info-label">OS</span>
                <span class="system-info-value">{{ system_info.os_info.name }}</span>
            </div>
            <div class="system-info-item">
                <span class="system-info-label">Kernel</span>
                <span class="system-info-value">{{ system_info.kernel }}</span>
            </div>
            <div class="system-info-item">
                <span class="system-info-label">Uptime</span>
                <span class="system-info-value">{{ system_info.uptime }}</span>
            </div>
        </div>
    </section>

    <!-- Connection Status -->
    <section class="section connection-section">
        <h2 class="section-title" data-icon="connection">Connection Status</h2>

        <div class="connection-grid">
            <div class="connection-card">
                <div class="connection-icon">üåê</div>
                <div class="connection-info">
                    <span class="connection-label">Internet</span>
                    <span class="connection-value" id="conn-internet">
                        {% if system_info.internet is none %}
                        <span class="status-badge skeleton">Checking...</span>
                        {% elif system_info.internet %}
                        <span class="status-badge success">Connected</span>
                        {% else %}
                        <span class="status-badge error">Not Connected</span>
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="connection-card">
                <div class="connection-icon">üì°</div>
                <div class="connection-info">
                    <span class="connection-label">IP Address</span>
                    <span class="connection-value" id="conn-ip">{{ system_info.ip_address or 'Checking...' }}</span>
                </div>
            </div>

            <div class="connection-card">
                <div class="connection-icon">üîç</div>
                <div class="connection-info">
                    <span class="connection-label">DNS</span>
                    <span class="connection-value" id="conn-dns">
                        {% if system_info.dns_working is none %}
                        <span class="status-badge skeleton">Checking...</span>
                        {% elif system_info.dns_working %}
                        <span class="status-badge success">Working</span>
                        {% else %}
                        <span class="status-badge error">Error</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </section>

    <!-- IP Configuration -->
    <section class="section ip-section">
        <h2 class="section-title" data-icon="network">IP Configuration</h2>

        <div class="ip-config-buttons">
            <p class="text-muted">Quickly change network configuration:</p>

            <div class="ip-buttons-row">
                <button class="btn btn-lg btn-ip-config" id="btn-default-ip" onclick="setDefaultIP()">
                    <span class="btn-icon">üîß</span>
                    <span class="btn-text">
                        <strong>Default IP</strong>
                        <small>5.5.5.55 / 5.5.5.1</small>
                    </span>
                </button>

                <button class="btn btn-lg btn-ip-config" id="btn-public-ip" onclick="setPublicIP()">
                    <span class="btn-icon">üåç</span>
                    <span class="btn-text">
                        <strong>Public IP</strong>
                        <small>DHCP (Automatic)</small>
                    </span>
                </button>
            </div>

            <div class="ip-mode-info" id="ip-mode-info">
                <span class="mode-indicator" id="mode-static" style="display: none;">
                    <span class="indicator-dot"></span> Static IP Active
                </span>
                <span class="mode-indicator" id="mode-dhcp" style="display: none;">
                    <span class="indicator-dot"></span> DHCP Active
                </span>
            </div>
        </div>
    </section>

    <!-- Component Status -->
    <section class="section component-status-section">
        <h2 class="section-title" data-icon="system">System Components</h2>

        <div class="component-grid">
            <!-- Docker -->
            <div class="component-card {% if components.docker.ok %}component-ok{% else %}component-error{% endif %}" id="component-docker">
                <div class="component-header">
                    <span class="component-icon">üê≥</span>
                    <span class="component-name">{{ components.docker.label }}</span>
                </div>
                <div class="component-status" id="component-docker-status">
                    {% if components.docker.ok %}
                    <span class="component-status-dot ok"></span>
                    <span>Running</span>
                    {% else %}
                    <span class="component-status-dot error"></span>
                    <span>Stopped</span>
                    {% endif %}
                </div>
                <div class="component-detail" id="component-docker-detail">{% if components.docker.version %}v{{ components.docker.version }}{% endif %}</div>
            </div>

            <!-- MongoDB -->
            <div class="component-card {% if components.mongodb.ok %}component-ok{% else %}component-error{% endif %}" id="component-mongodb">
                <div class="component-header">
                    <span class="component-icon">üçÉ</span>
                    <span class="component-name">{{ components.mongodb.label }}</span>
                </div>
                <div class="component-status" id="component-mongodb-status">
                    {% if components.mongodb.ok %}
                    <span class="component-status-dot ok"></span>
                    <span>Running</span>
                    {% else %}
                    <span class="component-status-dot error"></span>
                    <span>Stopped</span>
                    {% endif %}
                </div>
                <div class="component-detail" id="component-mongodb-detail">{{ components.mongodb.info or '' }}</div>
            </div>

            <!-- Remote Connection (Tailscale) -->
            <div class="component-card {% if components.tailscale.ok %}component-ok{% elif components.tailscale.status == 'not_enrolled' %}component-pending{% else %}component-error{% endif %}" id="component-tailscale">
                <div class="component-header">
                    <span class="component-icon">üîó</span>
                    <span class="component-name">{{ components.tailscale.label }}</span>
                </div>
                <div class="component-status" id="component-tailscale-status">
                    {% if components.tailscale.ok %}
                    <span class="component-status-dot ok"></span>
                    <span>Connected</span>
                    {% elif components.tailscale.status == 'disconnected' %}
                    <span class="component-status-dot error"></span>
                    <span>Disconnected</span>
                    {% else %}
                    <span class="component-status-dot pending"></span>
                    <span>Not Enrolled</span>
                    {% endif %}
                </div>
                <div class="component-detail" id="component-tailscale-detail">{{ components.tailscale.ip or '' }}</div>
            </div>

            <!-- NVIDIA -->
            <div class="component-card {% if components.nvidia.ok %}component-ok{% elif components.nvidia.status in ['mok_pending', 'reboot_required'] %}component-warning{% elif components.nvidia.status == 'not_installed' %}component-pending{% else %}component-error{% endif %}" id="component-nvidia">
                <div class="component-header">
                    <span class="component-icon">üñ•Ô∏è</span>
                    <span class="component-name">{{ components.nvidia.label }}</span>
                </div>
                <div class="component-status" id="component-nvidia-status">
                    {% if components.nvidia.ok %}
                    <span class="component-status-dot ok"></span>
                    <span>Working</span>
                    {% elif components.nvidia.status == 'mok_pending' %}
                    <span class="component-status-dot warning"></span>
                    <span>MOK Pending</span>
                    {% elif components.nvidia.status == 'reboot_required' %}
                    <span class="component-status-dot warning"></span>
                    <span>Reboot Required</span>
                    {% elif components.nvidia.status == 'not_working' %}
                    <span class="component-status-dot error"></span>
                    <span>Not Working</span>
                    {% else %}
                    <span class="component-status-dot pending"></span>
                    <span>Not Installed</span>
                    {% endif %}
                </div>
                <div class="component-detail" id="component-nvidia-detail">{% if components.nvidia.version %}Driver {{ components.nvidia.version }}{% endif %}</div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
// IP Mode Indicator
function updateIpModeIndicator() {
    const ipElement = document.getElementById('conn-ip');
    const ip = ipElement?.textContent?.trim();
    const staticIndicator = document.getElementById('mode-static');
    const dhcpIndicator = document.getElementById('mode-dhcp');

    if (!staticIndicator || !dhcpIndicator) return;

    if (ip && ip.startsWith('5.5.5.')) {
        staticIndicator.style.display = 'inline-flex';
        dhcpIndicator.style.display = 'none';
    } else if (ip && ip !== 'Checking...' && ip !== 'N/A' && ip !== '...') {
        staticIndicator.style.display = 'none';
        dhcpIndicator.style.display = 'inline-flex';
    } else {
        staticIndicator.style.display = 'none';
        dhcpIndicator.style.display = 'none';
    }
}

// Update on page load
setTimeout(updateIpModeIndicator, 500);

// RVM ID Form (new setup)
const rvmIdForm = document.getElementById('rvm-id-form');
if (rvmIdForm) {
    rvmIdForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = rvmIdForm.querySelector('input[name="rvm_id"]');
        const rvm_id = input.value.toUpperCase().trim();

        if (!rvm_id) {
            showToast('RVM ID required', 'error');
            return;
        }

        try {
            const response = await fetch('/api/rvm-id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rvm_id })
            });

            const data = await response.json();

            if (data.success) {
                showToast('RVM ID saved', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || 'Error occurred', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    });
}

// RVM ID Edit Toggle
function toggleRvmIdEdit(show) {
    const displayEl = document.getElementById('rvm-id-display');
    const editEl = document.getElementById('rvm-id-edit');
    if (!displayEl || !editEl) return;

    if (show) {
        displayEl.style.display = 'none';
        editEl.style.display = 'block';
        editEl.querySelector('input').focus();
    } else {
        displayEl.style.display = 'flex';
        editEl.style.display = 'none';
    }
}

// RVM ID Edit Form
const rvmIdEditForm = document.getElementById('rvm-id-edit-form');
if (rvmIdEditForm) {
    rvmIdEditForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = rvmIdEditForm.querySelector('input[name="rvm_id"]');
        const rvm_id = input.value.toUpperCase().trim();

        if (!rvm_id) {
            showToast('RVM ID required', 'error');
            return;
        }

        const btn = rvmIdEditForm.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            const response = await fetch('/api/rvm-id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rvm_id })
            });

            const data = await response.json();

            if (data.success) {
                showToast('RVM ID updated', 'success');
                document.getElementById('rvm-id-value').textContent = rvm_id;
                toggleRvmIdEdit(false);
            } else {
                showToast(data.error || 'Error occurred', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Save';
        }
    });
}

// Default IP (5.5.5.55)
async function setDefaultIP() {
    const btn = document.getElementById('btn-default-ip');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Setting...';

    try {
        const response = await fetch('/api/network/set-ip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'default' })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Default IP set: 5.5.5.55', 'success');
            document.getElementById('conn-ip').textContent = '5.5.5.55';
            updateIpModeIndicator();
        } else {
            showToast(data.error || 'Could not set IP', 'error');
        }
    } catch (error) {
        showToast('Connection error', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">üîß</span><span class="btn-text"><strong>Default IP</strong><small>5.5.5.55 / 5.5.5.1</small></span>';
    }
}

// Public IP (DHCP)
async function setPublicIP() {
    const btn = document.getElementById('btn-public-ip');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Setting...';

    try {
        const response = await fetch('/api/network/set-ip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'dhcp' })
        });

        const data = await response.json();

        if (data.success) {
            showToast('DHCP enabled', 'success');
            setTimeout(updateIpModeIndicator, 1000);
        } else {
            showToast(data.error || 'Could not set DHCP', 'error');
        }
    } catch (error) {
        showToast('Connection error', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">üåç</span><span class="btn-text"><strong>Public IP</strong><small>DHCP (Automatic)</small></span>';
    }
}

// System Reboot
async function systemReboot() {
    if (!confirm('Are you sure you want to reboot the system?')) {
        return;
    }

    try {
        const response = await fetch('/api/system/reboot', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showToast('System rebooting...', 'success');
        } else {
            showToast(data.error || 'Error occurred', 'error');
        }
    } catch (error) {
        showToast('Connection error', 'error');
    }
}

// System Shutdown
async function systemShutdown() {
    if (!confirm('Are you sure you want to shutdown the system?')) {
        return;
    }

    try {
        const response = await fetch('/api/system/shutdown', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showToast('System shutting down...', 'success');
        } else {
            showToast(data.error || 'Error occurred', 'error');
        }
    } catch (error) {
        showToast('Connection error', 'error');
    }
}

// =============================================================================
// System Components Auto-Update (with DOM caching)
// =============================================================================

let componentPollingInterval = null;

// Cached component DOM elements
const componentCache = {
    docker: { card: null, status: null, detail: null },
    mongodb: { card: null, status: null, detail: null },
    tailscale: { card: null, status: null, detail: null },
    nvidia: { card: null, status: null, detail: null },
    _initialized: false
};

function initComponentCache() {
    if (componentCache._initialized) return;
    ['docker', 'mongodb', 'tailscale', 'nvidia'].forEach(name => {
        componentCache[name].card = document.getElementById(`component-${name}`);
        componentCache[name].status = document.getElementById(`component-${name}-status`);
        componentCache[name].detail = document.getElementById(`component-${name}-detail`);
    });
    componentCache._initialized = true;
}

// State definitions (constant - defined once)
const COMPONENT_STATES = {
    tailscale: {
        'connected': { dot: 'ok', text: 'Connected', cardClass: 'component-ok' },
        'disconnected': { dot: 'error', text: 'Disconnected', cardClass: 'component-error' },
        'not_enrolled': { dot: 'pending', text: 'Not Enrolled', cardClass: 'component-pending' },
        'not_installed': { dot: 'pending', text: 'Not Installed', cardClass: 'component-pending' }
    },
    nvidia: {
        'working': { dot: 'ok', text: 'Working', cardClass: 'component-ok' },
        'not_working': { dot: 'error', text: 'Not Working', cardClass: 'component-error' },
        'mok_pending': { dot: 'warning', text: 'MOK Pending', cardClass: 'component-warning' },
        'reboot_required': { dot: 'warning', text: 'Reboot Required', cardClass: 'component-warning' },
        'not_installed': { dot: 'pending', text: 'Not Installed', cardClass: 'component-pending' }
    }
};

async function updateComponentStatuses() {
    if (!navigator.onLine) return;
    initComponentCache();

    try {
        const response = await fetch('/api/system/components', { signal: AbortSignal.timeout(5000) });
        const data = await response.json();

        // Update Docker & MongoDB (simple ok/error states)
        updateSimpleComponent('docker', data.docker, data.docker.version ? `v${data.docker.version}` : '');
        updateSimpleComponent('mongodb', data.mongodb, data.mongodb.info || '');

        // Update Tailscale (multiple states)
        const tsState = COMPONENT_STATES.tailscale[data.tailscale.status] || COMPONENT_STATES.tailscale['not_enrolled'];
        updateComplexComponent('tailscale', tsState, data.tailscale.ip || '');

        // Update NVIDIA (multiple states)
        const nvState = COMPONENT_STATES.nvidia[data.nvidia.status] || COMPONENT_STATES.nvidia['not_installed'];
        updateComplexComponent('nvidia', nvState, data.nvidia.version ? `Driver ${data.nvidia.version}` : '');

    } catch (error) {
        console.warn('Component status update failed:', error.message || error);
    }
}

function updateSimpleComponent(name, data, detail) {
    const { card, status, detail: detailEl } = componentCache[name];
    if (!card || !status) return;

    const isOk = data.ok;
    const newCardClass = isOk ? 'component-ok' : 'component-error';

    // Use classList for minimal reflow
    card.classList.remove('component-ok', 'component-error', 'component-warning', 'component-pending');
    card.classList.add(newCardClass);

    status.innerHTML = `<span class="component-status-dot ${isOk ? 'ok' : 'error'}"></span><span>${isOk ? 'Running' : 'Stopped'}</span>`;
    if (detailEl) detailEl.textContent = detail;
}

function updateComplexComponent(name, state, detail) {
    const { card, status, detail: detailEl } = componentCache[name];
    if (!card || !status) return;

    // Use classList for minimal reflow
    card.classList.remove('component-ok', 'component-error', 'component-warning', 'component-pending');
    card.classList.add(state.cardClass);

    status.innerHTML = `<span class="component-status-dot ${state.dot}"></span><span>${state.text}</span>`;
    if (detailEl) detailEl.textContent = detail;
}

function startComponentPolling() {
    if (componentPollingInterval) return;
    componentPollingInterval = setInterval(() => {
        if (!document.hidden) updateComponentStatuses();
    }, 10000); // Her 10 saniyede bir g√ºncelle
}

function stopComponentPolling() {
    if (componentPollingInterval) {
        clearInterval(componentPollingInterval);
        componentPollingInterval = null;
    }
}

// Start polling on page load
document.addEventListener('DOMContentLoaded', () => {
    startComponentPolling();
});

// Handle visibility changes
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopComponentPolling();
    } else {
        startComponentPolling();
        updateComponentStatuses(); // Hemen g√ºncelle
    }
});
</script>
{% endblock %}
