{% extends "base.html" %}

{% block title %}Home - ACO Maintenance Panel{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- System Control -->
    <div class="system-controls">
        <button class="btn btn-power btn-reboot" onclick="systemReboot()">
            <span class="btn-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M1 4v6h6M23 20v-6h-6"/>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                </svg>
            </span>
            Reboot
        </button>

        <div class="system-settings">
            <div class="system-clock" id="system-clock">
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span class="clock-datetime" id="clock-datetime">--.--.---- --:--:--</span>
                <span class="clock-timezone" id="clock-timezone"></span>
            </div>

            <div class="system-control-select">
                <label class="control-select-label" for="timezone-select">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    Timezone
                </label>
                <select id="timezone-select" class="select-input select-input-sm" onchange="changeTimezone(this.value)" disabled>
                    <option value="">Loading...</option>
                </select>
            </div>

            <div class="system-control-select">
                <label class="control-select-label" for="keyboard-select">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2" ry="2"/>
                        <line x1="6" y1="8" x2="6.01" y2="8"/>
                        <line x1="10" y1="8" x2="10.01" y2="8"/>
                        <line x1="14" y1="8" x2="14.01" y2="8"/>
                        <line x1="18" y1="8" x2="18.01" y2="8"/>
                        <line x1="8" y1="12" x2="8.01" y2="12"/>
                        <line x1="12" y1="12" x2="12.01" y2="12"/>
                        <line x1="16" y1="12" x2="16.01" y2="12"/>
                        <line x1="7" y1="16" x2="17" y2="16"/>
                    </svg>
                    Keyboard
                </label>
                <select id="keyboard-select" class="select-input select-input-sm" onchange="changeKeyboard(this.value)" disabled>
                    <option value="">Loading...</option>
                </select>
            </div>
        </div>
    </div>

    <!-- RVM ID Section -->
    <section class="section rvm-section">
        <h2 class="section-title" data-icon="config">RVM Identity</h2>

        {% if rvm_id %}
        <!-- Display Mode -->
        <div class="rvm-id-display" id="rvm-id-display">
            <span class="rvm-id-label">RVM ID:</span>
            <span class="rvm-id-value" id="rvm-id-value">{{ rvm_id }}</span>
            {% if not tailscale_completed %}
            <button class="btn btn-icon btn-sm" onclick="toggleRvmIdEdit(true)" title="Edit RVM ID">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </button>
            {% endif %}
        </div>

        {% if not tailscale_completed %}
        <!-- Edit Mode (hidden by default) -->
        <div class="rvm-id-panel rvm-id-edit" id="rvm-id-edit" style="display: none;">
            <form id="rvm-id-edit-form" class="rvm-id-form">
                <div class="form-group">
                    <input type="text" name="rvm_id" class="form-control"
                           value="{{ rvm_id }}" pattern="[A-Z0-9_-]+"
                           title="Only uppercase letters, numbers, hyphens and underscores"
                           aria-label="RVM ID">
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Save</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleRvmIdEdit(false)">Cancel</button>
            </form>
        </div>
        {% endif %}
        {% else %}
        <div class="rvm-id-panel">
            <p class="text-muted">You must set RVM ID before starting installation.</p>

            <form id="rvm-id-form" class="rvm-id-form">
                <div class="form-group">
                    <input type="text" name="rvm_id" class="form-control form-control-lg"
                           placeholder="RVM-001" pattern="[A-Z0-9_-]+"
                           title="Only uppercase letters, numbers, hyphens and underscores"
                           aria-label="RVM ID">
                    <small class="text-muted">Example: RVM-001, BRANCH-NYC-01</small>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
        {% endif %}
    </section>

    <!-- System Info -->
    <section class="section system-info-section">
        <h2 class="section-title" data-icon="system">System Information</h2>
        <div class="system-info-grid">
            <div class="system-info-item">
                <span class="system-info-label">Hostname</span>
                <span class="system-info-value">{{ system_info.hostname }}</span>
            </div>
            <div class="system-info-item">
                <span class="system-info-label">OS</span>
                <span class="system-info-value">{{ system_info.os_info.name }}</span>
            </div>
            <div class="system-info-item">
                <span class="system-info-label">Kernel</span>
                <span class="system-info-value">{{ system_info.kernel }}</span>
            </div>
            <div class="system-info-item">
                <span class="system-info-label">Uptime</span>
                <span class="system-info-value">{{ system_info.uptime }}</span>
            </div>
        </div>
    </section>

    <!-- Connection Status -->
    <section class="section connection-section">
        <h2 class="section-title" data-icon="connection">Connection Status</h2>

        <div class="connection-grid">
            <div class="connection-card">
                <div class="connection-icon">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                </div>
                <div class="connection-info">
                    <span class="connection-label">Internet</span>
                    <span class="connection-value" id="conn-internet">
                        {% if system_info.internet is none %}
                        <span class="status-badge skeleton">Checking...</span>
                        {% elif system_info.internet %}
                        <span class="status-badge success">Connected</span>
                        {% else %}
                        <span class="status-badge error">Not Connected</span>
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="connection-card">
                <div class="connection-icon">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                </div>
                <div class="connection-info">
                    <span class="connection-label">DNS</span>
                    <span class="connection-value" id="conn-dns">
                        {% if system_info.dns_working is none %}
                        <span class="status-badge skeleton">Checking...</span>
                        {% elif system_info.dns_working %}
                        <span class="status-badge success">Working</span>
                        {% else %}
                        <span class="status-badge error">Error</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </section>

    <!-- IP Configuration -->
    <section class="section ip-section">
        <h2 class="section-title" data-icon="network">IP Configuration</h2>

        <div class="interface-cards" id="interface-cards">
            <!-- Interfaces will be loaded dynamically -->
            <div class="interface-card skeleton-card">
                <div class="interface-header">
                    <span class="interface-name">Loading...</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Component Status -->
    <section class="section component-status-section">
        <h2 class="section-title" data-icon="system">System Components</h2>

        <div class="component-grid">
            <!-- Docker -->
            <div class="component-card {% if components.docker.ok %}component-ok{% else %}component-error{% endif %}" id="component-docker">
                <div class="component-header">
                    <span class="component-icon">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                            <line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                    </span>
                    <span class="component-name">{{ components.docker.label }}</span>
                </div>
                <div class="component-status" id="component-docker-status">
                    {% if components.docker.ok %}
                    <span class="component-status-dot ok"></span>
                    <span>Running</span>
                    {% else %}
                    <span class="component-status-dot error"></span>
                    <span>Stopped</span>
                    {% endif %}
                </div>
                <div class="component-detail" id="component-docker-detail">{% if components.docker.version %}v{{ components.docker.version }}{% endif %}</div>
            </div>

            <!-- MongoDB -->
            <div class="component-card {% if components.mongodb.ok %}component-ok{% else %}component-error{% endif %}" id="component-mongodb">
                <div class="component-header">
                    <span class="component-icon">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <ellipse cx="12" cy="5" rx="9" ry="3"/>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                        </svg>
                    </span>
                    <span class="component-name">{{ components.mongodb.label }}</span>
                </div>
                <div class="component-status" id="component-mongodb-status">
                    {% if components.mongodb.ok %}
                    <span class="component-status-dot ok"></span>
                    <span>Running</span>
                    {% else %}
                    <span class="component-status-dot error"></span>
                    <span>Stopped</span>
                    {% endif %}
                </div>
                <div class="component-detail" id="component-mongodb-detail">{{ components.mongodb.info or '' }}</div>
            </div>

            <!-- Remote Connection (Tailscale) -->
            <div class="component-card {% if components.tailscale.ok %}component-ok{% elif components.tailscale.status == 'not_enrolled' %}component-pending{% else %}component-error{% endif %}" id="component-tailscale">
                <div class="component-header">
                    <span class="component-icon">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                        </svg>
                    </span>
                    <span class="component-name">{{ components.tailscale.label }}</span>
                </div>
                <div class="component-status" id="component-tailscale-status">
                    {% if components.tailscale.ok %}
                    <span class="component-status-dot ok"></span>
                    <span>Connected</span>
                    {% elif components.tailscale.status == 'disconnected' %}
                    <span class="component-status-dot error"></span>
                    <span>Disconnected</span>
                    {% else %}
                    <span class="component-status-dot pending"></span>
                    <span>Not Enrolled</span>
                    {% endif %}
                </div>
                <div class="component-detail" id="component-tailscale-detail">{{ components.tailscale.ip or '' }}</div>
            </div>

            <!-- NVIDIA -->
            <div class="component-card {% if components.nvidia.ok %}component-ok{% elif components.nvidia.status in ['mok_pending', 'reboot_required'] %}component-warning{% elif components.nvidia.status == 'not_installed' %}component-pending{% else %}component-error{% endif %}" id="component-nvidia">
                <div class="component-header">
                    <span class="component-icon">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                            <line x1="8" y1="21" x2="16" y2="21"/>
                            <line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                    </span>
                    <span class="component-name">{{ components.nvidia.label }}</span>
                </div>
                <div class="component-status" id="component-nvidia-status">
                    {% if components.nvidia.ok %}
                    <span class="component-status-dot ok"></span>
                    <span>Working</span>
                    {% elif components.nvidia.status == 'mok_pending' %}
                    <span class="component-status-dot warning"></span>
                    <span>MOK Pending</span>
                    {% elif components.nvidia.status == 'reboot_required' %}
                    <span class="component-status-dot warning"></span>
                    <span>Reboot Required</span>
                    {% elif components.nvidia.status == 'not_working' %}
                    <span class="component-status-dot error"></span>
                    <span>Not Working</span>
                    {% else %}
                    <span class="component-status-dot pending"></span>
                    <span>Not Installed</span>
                    {% endif %}
                </div>
                <div class="component-detail" id="component-nvidia-detail">{% if components.nvidia.version %}Driver {{ components.nvidia.version }}{% endif %}</div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/home.js') }}"></script>
{% endblock %}
