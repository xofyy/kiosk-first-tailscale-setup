{% extends "base.html" %}

{% block title %}Home - Kiosk Setup Panel{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- System Control -->
    <div class="system-controls">
        <button class="btn btn-power btn-reboot" onclick="systemReboot()">
            <span class="btn-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M1 4v6h6M23 20v-6h-6"/>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                </svg>
            </span>
            Reboot
        </button>
        <button class="btn btn-power btn-shutdown" onclick="systemShutdown()">
            <span class="btn-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/>
                    <line x1="12" y1="2" x2="12" y2="12"/>
                </svg>
            </span>
            Shutdown
        </button>
    </div>

    <!-- Kiosk ID Section -->
    <section class="section kiosk-section">
        <h2 class="section-title">Kiosk Identity</h2>

        {% if kiosk_id %}
        <!-- Display Mode -->
        <div class="kiosk-id-display" id="kiosk-id-display">
            <span class="kiosk-id-label">Kiosk ID:</span>
            <span class="kiosk-id-value" id="kiosk-id-value">{{ kiosk_id }}</span>
            {% if not tailscale_completed %}
            <button class="btn btn-icon btn-sm" onclick="toggleKioskIdEdit(true)" title="Edit Kiosk ID">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </button>
            {% endif %}
        </div>

        {% if not tailscale_completed %}
        <!-- Edit Mode (hidden by default) -->
        <div class="kiosk-id-panel kiosk-id-edit" id="kiosk-id-edit" style="display: none;">
            <form id="kiosk-id-edit-form" class="kiosk-id-form">
                <div class="form-group">
                    <input type="text" name="kiosk_id" class="form-control"
                           value="{{ kiosk_id }}" pattern="[A-Z0-9_-]+"
                           title="Only uppercase letters, numbers, hyphens and underscores">
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Save</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleKioskIdEdit(false)">Cancel</button>
            </form>
        </div>
        {% endif %}
        {% else %}
        <div class="kiosk-id-panel">
            <p class="text-muted">You must set Kiosk ID before starting installation.</p>

            <form id="kiosk-id-form" class="kiosk-id-form">
                <div class="form-group">
                    <input type="text" name="kiosk_id" class="form-control form-control-lg"
                           placeholder="KIOSK-001" pattern="[A-Z0-9_-]+"
                           title="Only uppercase letters, numbers, hyphens and underscores">
                    <small class="text-muted">Example: KIOSK-001, BRANCH-NYC-01</small>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
        {% endif %}
    </section>

    <!-- Connection Status -->
    <section class="section connection-section">
        <h2 class="section-title">Connection Status</h2>

        <div class="connection-grid">
            <div class="connection-card">
                <div class="connection-icon">üåê</div>
                <div class="connection-info">
                    <span class="connection-label">Internet</span>
                    <span class="connection-value" id="conn-internet">
                        {% if system_info.internet is none %}
                        <span class="status-badge">Checking...</span>
                        {% elif system_info.internet %}
                        <span class="status-badge success">Connected</span>
                        {% else %}
                        <span class="status-badge error">Not Connected</span>
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="connection-card">
                <div class="connection-icon">üì°</div>
                <div class="connection-info">
                    <span class="connection-label">IP Address</span>
                    <span class="connection-value" id="conn-ip">{{ system_info.ip_address or 'Checking...' }}</span>
                </div>
            </div>

            <div class="connection-card">
                <div class="connection-icon">üîó</div>
                <div class="connection-info">
                    <span class="connection-label">Tailscale IP</span>
                    <span class="connection-value" id="conn-tailscale">{{ system_info.tailscale_ip or 'Not connected' }}</span>
                </div>
            </div>

            <div class="connection-card">
                <div class="connection-icon">üîç</div>
                <div class="connection-info">
                    <span class="connection-label">DNS</span>
                    <span class="connection-value" id="conn-dns">
                        {% if system_info.dns_working is none %}
                        <span class="status-badge">Checking...</span>
                        {% elif system_info.dns_working %}
                        <span class="status-badge success">Working</span>
                        {% else %}
                        <span class="status-badge error">Error</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </section>

    <!-- IP Configuration -->
    <section class="section ip-section">
        <h2 class="section-title">IP Configuration</h2>

        <div class="ip-config-buttons">
            <p class="text-muted">Quickly change network configuration:</p>

            <div class="ip-buttons-row">
                <button class="btn btn-lg btn-ip-config" id="btn-default-ip" onclick="setDefaultIP()">
                    <span class="btn-icon">üîß</span>
                    <span class="btn-text">
                        <strong>Default IP</strong>
                        <small>5.5.5.55 / 5.5.5.1</small>
                    </span>
                </button>

                <button class="btn btn-lg btn-ip-config" id="btn-public-ip" onclick="setPublicIP()">
                    <span class="btn-icon">üåç</span>
                    <span class="btn-text">
                        <strong>Public IP</strong>
                        <small>DHCP (Automatic)</small>
                    </span>
                </button>
            </div>

            <div class="ip-mode-info" id="ip-mode-info">
                <span class="mode-indicator" id="mode-static" style="display: none;">
                    <span class="indicator-dot"></span> Static IP Active
                </span>
                <span class="mode-indicator" id="mode-dhcp" style="display: none;">
                    <span class="indicator-dot"></span> DHCP Active
                </span>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
// IP Mode Indicator
function updateIpModeIndicator() {
    const ipElement = document.getElementById('conn-ip');
    const ip = ipElement?.textContent?.trim();
    const staticIndicator = document.getElementById('mode-static');
    const dhcpIndicator = document.getElementById('mode-dhcp');

    if (!staticIndicator || !dhcpIndicator) return;

    if (ip && ip.startsWith('5.5.5.')) {
        staticIndicator.style.display = 'inline-flex';
        dhcpIndicator.style.display = 'none';
    } else if (ip && ip !== 'Checking...' && ip !== 'N/A' && ip !== '...') {
        staticIndicator.style.display = 'none';
        dhcpIndicator.style.display = 'inline-flex';
    } else {
        staticIndicator.style.display = 'none';
        dhcpIndicator.style.display = 'none';
    }
}

// Update on page load
setTimeout(updateIpModeIndicator, 500);

// Kiosk ID Form (new setup)
const kioskIdForm = document.getElementById('kiosk-id-form');
if (kioskIdForm) {
    kioskIdForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = kioskIdForm.querySelector('input[name="kiosk_id"]');
        const kiosk_id = input.value.toUpperCase().trim();

        if (!kiosk_id) {
            showToast('Kiosk ID required', 'error');
            return;
        }

        try {
            const response = await fetch('/api/kiosk-id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ kiosk_id })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Kiosk ID saved', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || 'Error occurred', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    });
}

// Kiosk ID Edit Toggle
function toggleKioskIdEdit(show) {
    const displayEl = document.getElementById('kiosk-id-display');
    const editEl = document.getElementById('kiosk-id-edit');
    if (!displayEl || !editEl) return;

    if (show) {
        displayEl.style.display = 'none';
        editEl.style.display = 'block';
        editEl.querySelector('input').focus();
    } else {
        displayEl.style.display = 'flex';
        editEl.style.display = 'none';
    }
}

// Kiosk ID Edit Form
const kioskIdEditForm = document.getElementById('kiosk-id-edit-form');
if (kioskIdEditForm) {
    kioskIdEditForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = kioskIdEditForm.querySelector('input[name="kiosk_id"]');
        const kiosk_id = input.value.toUpperCase().trim();

        if (!kiosk_id) {
            showToast('Kiosk ID required', 'error');
            return;
        }

        const btn = kioskIdEditForm.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            const response = await fetch('/api/kiosk-id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ kiosk_id })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Kiosk ID updated', 'success');
                document.getElementById('kiosk-id-value').textContent = kiosk_id;
                toggleKioskIdEdit(false);
            } else {
                showToast(data.error || 'Error occurred', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Save';
        }
    });
}

// Default IP (5.5.5.55)
async function setDefaultIP() {
    const btn = document.getElementById('btn-default-ip');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Setting...';

    try {
        const response = await fetch('/api/network/set-ip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'default' })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Default IP set: 5.5.5.55', 'success');
            document.getElementById('conn-ip').textContent = '5.5.5.55';
            updateIpModeIndicator();
        } else {
            showToast(data.error || 'Could not set IP', 'error');
        }
    } catch (error) {
        showToast('Connection error', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">üîß</span><span class="btn-text"><strong>Default IP</strong><small>5.5.5.55 / 5.5.5.1</small></span>';
    }
}

// Public IP (DHCP)
async function setPublicIP() {
    const btn = document.getElementById('btn-public-ip');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Setting...';

    try {
        const response = await fetch('/api/network/set-ip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'dhcp' })
        });

        const data = await response.json();

        if (data.success) {
            showToast('DHCP enabled', 'success');
            setTimeout(updateIpModeIndicator, 1000);
        } else {
            showToast(data.error || 'Could not set DHCP', 'error');
        }
    } catch (error) {
        showToast('Connection error', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">üåç</span><span class="btn-text"><strong>Public IP</strong><small>DHCP (Automatic)</small></span>';
    }
}

// System Reboot
async function systemReboot() {
    if (!confirm('Are you sure you want to reboot the system?')) {
        return;
    }

    try {
        const response = await fetch('/api/system/reboot', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showToast('System rebooting...', 'success');
        } else {
            showToast(data.error || 'Error occurred', 'error');
        }
    } catch (error) {
        showToast('Connection error', 'error');
    }
}

// System Shutdown
async function systemShutdown() {
    if (!confirm('Are you sure you want to shutdown the system?')) {
        return;
    }

    try {
        const response = await fetch('/api/system/shutdown', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showToast('System shutting down...', 'success');
        } else {
            showToast(data.error || 'Error occurred', 'error');
        }
    } catch (error) {
        showToast('Connection error', 'error');
    }
}
</script>
{% endblock %}
