{% extends "base.html" %}

{% block title %}Anasayfa - Kiosk Setup Panel{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Sistem Kontrol -->
    <div class="system-controls">
        <button class="btn btn-power btn-reboot" onclick="systemReboot()">
            <span class="btn-icon">â†»</span>
            Yeniden BaÅŸlat
        </button>
        <button class="btn btn-power btn-shutdown" onclick="systemShutdown()">
            <span class="btn-icon">â»</span>
            Kapat
        </button>
    </div>

    <!-- Kiosk ID BÃ¶lÃ¼mÃ¼ -->
    <section class="section kiosk-section">
        <h2 class="section-title">Kiosk KimliÄŸi</h2>

        {% if kiosk_id %}
        <div class="kiosk-id-display">
            <span class="kiosk-id-label">Kiosk ID:</span>
            <span class="kiosk-id-value">{{ kiosk_id }}</span>
        </div>
        {% else %}
        <div class="kiosk-id-panel">
            <p class="text-muted">Kuruluma baÅŸlamadan Ã¶nce Kiosk ID belirlemelisiniz.</p>

            <form id="kiosk-id-form" class="kiosk-id-form">
                <div class="form-group">
                    <input type="text" name="kiosk_id" class="form-control form-control-lg"
                           placeholder="KIOSK-001" pattern="[A-Z0-9_-]+"
                           title="Sadece bÃ¼yÃ¼k harf, rakam, tire ve alt Ã§izgi">
                    <small class="text-muted">Ã–rnek: KIOSK-001, BRANCH-ISTANBUL-01</small>
                </div>
                <button type="submit" class="btn btn-primary">Kaydet</button>
            </form>
        </div>
        {% endif %}
    </section>

    <!-- BaÄŸlantÄ± Durumu -->
    <section class="section connection-section">
        <h2 class="section-title">BaÄŸlantÄ± Durumu</h2>

        <div class="connection-grid">
            <div class="connection-card">
                <div class="connection-icon">ğŸŒ</div>
                <div class="connection-info">
                    <span class="connection-label">Ä°nternet</span>
                    <span class="connection-value" id="conn-internet">
                        {% if system_info.internet is none %}
                        <span class="status-badge">Kontrol ediliyor...</span>
                        {% elif system_info.internet %}
                        <span class="status-badge success">BaÄŸlÄ±</span>
                        {% else %}
                        <span class="status-badge error">BaÄŸlÄ± DeÄŸil</span>
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="connection-card">
                <div class="connection-icon">ğŸ“¡</div>
                <div class="connection-info">
                    <span class="connection-label">IP Adresi</span>
                    <span class="connection-value" id="conn-ip">{{ system_info.ip_address or 'Kontrol ediliyor...' }}</span>
                </div>
            </div>

            <div class="connection-card">
                <div class="connection-icon">ğŸ”—</div>
                <div class="connection-info">
                    <span class="connection-label">Tailscale IP</span>
                    <span class="connection-value" id="conn-tailscale">{{ system_info.tailscale_ip or 'BaÄŸlÄ± deÄŸil' }}</span>
                </div>
            </div>

            <div class="connection-card">
                <div class="connection-icon">ğŸ”</div>
                <div class="connection-info">
                    <span class="connection-label">DNS</span>
                    <span class="connection-value" id="conn-dns">
                        {% if system_info.dns_working is none %}
                        <span class="status-badge">Kontrol ediliyor...</span>
                        {% elif system_info.dns_working %}
                        <span class="status-badge success">Ã‡alÄ±ÅŸÄ±yor</span>
                        {% else %}
                        <span class="status-badge error">Hata</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </section>

    <!-- IP YapÄ±landÄ±rma -->
    <section class="section ip-section">
        <h2 class="section-title">IP YapÄ±landÄ±rma</h2>

        <div class="ip-config-buttons">
            <p class="text-muted">AÄŸ yapÄ±landÄ±rmasÄ±nÄ± hÄ±zlÄ±ca deÄŸiÅŸtirin:</p>

            <div class="ip-buttons-row">
                <button class="btn btn-lg btn-ip-config" id="btn-default-ip" onclick="setDefaultIP()">
                    <span class="btn-icon">ğŸ”§</span>
                    <span class="btn-text">
                        <strong>Default IP</strong>
                        <small>5.5.5.55 / 5.5.5.1</small>
                    </span>
                </button>

                <button class="btn btn-lg btn-ip-config" id="btn-public-ip" onclick="setPublicIP()">
                    <span class="btn-icon">ğŸŒ</span>
                    <span class="btn-text">
                        <strong>Public IP</strong>
                        <small>DHCP (Otomatik)</small>
                    </span>
                </button>
            </div>

            <p class="ip-current-info" id="ip-current-info">
                Mevcut: <strong id="current-ip-display">{{ system_info.ip_address or '...' }}</strong>
            </p>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Kiosk ID Form
const kioskIdForm = document.getElementById('kiosk-id-form');
if (kioskIdForm) {
    kioskIdForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = kioskIdForm.querySelector('input[name="kiosk_id"]');
        const kiosk_id = input.value.toUpperCase().trim();

        if (!kiosk_id) {
            showToast('Kiosk ID gerekli', 'error');
            return;
        }

        try {
            const response = await fetch('/api/kiosk-id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ kiosk_id })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Kiosk ID kaydedildi', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || 'Hata oluÅŸtu', 'error');
            }
        } catch (error) {
            showToast('BaÄŸlantÄ± hatasÄ±', 'error');
        }
    });
}

// Default IP (5.5.5.55)
async function setDefaultIP() {
    const btn = document.getElementById('btn-default-ip');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> AyarlanÄ±yor...';

    try {
        const response = await fetch('/api/network/set-ip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'default' })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Default IP ayarlandÄ±: 5.5.5.55', 'success');
            document.getElementById('current-ip-display').textContent = '5.5.5.55';
            updateConnectionStatus();
        } else {
            showToast(data.error || 'IP ayarlanamadÄ±', 'error');
        }
    } catch (error) {
        showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">ğŸ”§</span><span class="btn-text"><strong>Default IP</strong><small>5.5.5.55 / 5.5.5.1</small></span>';
    }
}

// Public IP (DHCP)
async function setPublicIP() {
    const btn = document.getElementById('btn-public-ip');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> AyarlanÄ±yor...';

    try {
        const response = await fetch('/api/network/set-ip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'dhcp' })
        });

        const data = await response.json();

        if (data.success) {
            showToast('DHCP aktif edildi', 'success');
            updateConnectionStatus();
        } else {
            showToast(data.error || 'DHCP ayarlanamadÄ±', 'error');
        }
    } catch (error) {
        showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">ğŸŒ</span><span class="btn-text"><strong>Public IP</strong><small>DHCP (Otomatik)</small></span>';
    }
}

// Sistem Yeniden BaÅŸlat
async function systemReboot() {
    if (!confirm('Sistemi yeniden baÅŸlatmak istediÄŸinize emin misiniz?')) {
        return;
    }

    try {
        const response = await fetch('/api/system/reboot', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showToast('Sistem yeniden baÅŸlatÄ±lÄ±yor...', 'success');
        } else {
            showToast(data.error || 'Hata oluÅŸtu', 'error');
        }
    } catch (error) {
        showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
}

// Sistem Kapat
async function systemShutdown() {
    if (!confirm('Sistemi kapatmak istediÄŸinize emin misiniz?')) {
        return;
    }

    try {
        const response = await fetch('/api/system/shutdown', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showToast('Sistem kapatÄ±lÄ±yor...', 'success');
        } else {
            showToast(data.error || 'Hata oluÅŸtu', 'error');
        }
    } catch (error) {
        showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
}
</script>
{% endblock %}
