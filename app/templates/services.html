{% extends "base.html" %}

{% block title %}Services - ACO Maintenance Panel{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/services.css') }}">
{% endblock %}

{% block content %}
<div class="services-page">
    <!-- Services List View -->
    <div id="services-list">
        <div class="services-header">
            <h2>
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"/>
                </svg>
                Docker Services
            </h2>
            <p>Manage and monitor Docker containers</p>
        </div>

        <div class="services-content">
            {% if containers %}
            <div class="service-cards">
                {% for container in containers %}
                <div class="service-card {{ container.status }}" data-service="{{ container.service_name }}">
                    <div class="service-card-header">
                        <div class="service-title">
                            <span class="service-icon" data-icon="{{ container.icon }}"></span>
                            <h3>{{ container.display_name }}</h3>
                        </div>
                        <span class="service-badge {{ container.status }}">
                            <span class="dot"></span>
                            {{ container.status | capitalize }}
                        </span>
                    </div>

                    <div class="service-info">
                        <div class="service-info-row">
                            <span class="label">Type</span>
                            <span class="value">{{ 'Web UI' if container.type == 'webui' else 'Background' }}</span>
                        </div>
                        {% if container.port %}
                        <div class="service-info-row">
                            <span class="label">Port</span>
                            <span class="value">{{ container.port }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="service-actions">
                        <!-- Web UI: Open button (only when running) -->
                        {% if container.type == 'webui' and container.status == 'running' %}
                        <button class="btn-action btn-open"
                                onclick='openService({{ container.port }}, {{ container.path | tojson }}, {{ container.display_name | tojson }})'
                                title="Open in iframe">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                            Open
                        </button>
                        {% endif %}

                        <!-- Management buttons -->
                        <div class="btn-group">
                            {% if container.status == 'running' %}
                            <button class="btn-action btn-stop"
                                    onclick='containerAction({{ container.service_name | tojson }}, "stop")'
                                    title="Stop container">
                                <svg class="icon-sm" viewBox="0 0 24 24" fill="currentColor">
                                    <rect x="6" y="6" width="12" height="12" rx="1"/>
                                </svg>
                            </button>
                            <button class="btn-action btn-restart"
                                    onclick='containerAction({{ container.service_name | tojson }}, "restart")'
                                    title="Restart container">
                                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M23 4v6h-6M1 20v-6h6"/>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                </svg>
                            </button>
                            {% else %}
                            <button class="btn-action btn-start"
                                    onclick='containerAction({{ container.service_name | tojson }}, "start")'
                                    title="Start container">
                                <svg class="icon-sm" viewBox="0 0 24 24" fill="currentColor">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                            </button>
                            {% endif %}

                            <!-- Logs button (always available) -->
                            <button class="btn-action btn-logs"
                                    onclick='openLogs({{ container.service_name | tojson }}, {{ container.display_name | tojson }})'
                                    title="View logs">
                                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-services">
                <div class="no-services-icon">
                    <svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"/>
                    </svg>
                </div>
                <h3>No Containers Found</h3>
                <p>Docker Compose configuration not found at /srv/docker or no services defined.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Inline Frame View -->
    <div class="service-frame-container" id="frame-container">
        <div class="frame-header">
            <button class="btn-back" onclick="closeFrame()">
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5"/>
                    <polyline points="12 19 5 12 12 5"/>
                </svg>
                Back
            </button>
            <span class="frame-title" id="frame-title">Service</span>
            <span class="frame-subtitle">ESC to close</span>
        </div>
        <div class="frame-wrapper">
            <div class="frame-loading" id="frame-loading">
                <div class="spinner"></div>
                <span>Loading...</span>
            </div>
            <iframe id="service-frame" class="service-frame" src=""></iframe>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div class="log-modal" id="log-modal">
        <div class="log-modal-content">
            <div class="log-modal-header">
                <h3 id="log-modal-title">Container Logs</h3>
                <button class="btn-close" onclick="closeLogs()">&times;</button>
            </div>
            <div class="log-modal-body">
                <pre id="log-content"></pre>
            </div>
            <div class="log-modal-footer">
                <span id="log-status">Connecting...</span>
                <label class="checkbox-label">
                    <input type="checkbox" id="log-auto-scroll" checked>
                    Auto-scroll
                </label>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/services.js') }}"></script>
{% endblock %}
