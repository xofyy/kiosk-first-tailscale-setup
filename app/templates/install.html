{% extends "base.html" %}

{% block title %}Install - ACO Maintenance Panel{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- RVM ID Warning (if not set) -->
    {% if not rvm_id %}
    <div class="alert alert-warning">
        <strong>Warning:</strong> You must set RVM ID from
        <a href="{{ url_for('pages.home') }}">Home</a> before starting installation.
    </div>
    {% endif %}

    <!-- Installation Modules -->
    <section class="section modules-section">
        <h2 class="section-title">Installation Modules</h2>

        <div class="progress-bar">
            <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
        </div>
        <p class="progress-text" id="progress-text">0 / {{ modules|length }} modules completed</p>

        <div class="modules-list">
            {% for module in modules %}
            {% set status = module_statuses.get(module.name, 'pending') %}
            <div class="module-card" data-module="{{ module.name }}" data-status="{{ status }}">
                <div class="module-order">{{ module.order }}</div>

                <div class="module-info">
                    <h3 class="module-name">{{ module.display_name }}</h3>
                    <p class="module-desc">{{ module.description }}</p>
                    {% if module.dependencies %}
                    <span class="module-deps">Dependency: {{ module.dependencies | join(', ') }}</span>
                    {% endif %}
                </div>

                <div class="module-status">
                    {% if status == 'completed' %}
                    <span class="status-badge success">‚úì Completed</span>
                    {% elif status == 'installing' %}
                    <span class="status-badge warning">‚ü≥ Installing...</span>
                    {% elif status == 'failed' %}
                    <span class="status-badge error">‚úó Error</span>
                    {% elif status == 'reboot_required' %}
                    <span class="status-badge info">‚Üª Reboot Required</span>
                    {% elif status == 'mok_pending' %}
                    <span class="status-badge info">üîê MOK Pending</span>
                    {% else %}
                    <span class="status-badge">Pending</span>
                    {% endif %}

                    {% if module.name == 'nvidia' %}
                    <div id="nvidia-mok-info"></div>
                    {% endif %}
                </div>

                <div class="module-actions">
                    {% if status == 'completed' %}
                    <button class="btn btn-secondary" disabled>Installed</button>
                    {% elif status == 'installing' %}
                    <button class="btn btn-secondary" disabled>
                        <span class="spinner"></span> Installing
                    </button>
                    {% elif status == 'reboot_required' or status == 'mok_pending' %}
                    <button class="btn btn-warning btn-reboot" onclick="rebootSystem()">
                        Reboot
                    </button>
                    {% else %}
                    <button class="btn btn-primary btn-install"
                            data-module="{{ module.name }}"
                            onclick="installModule('{{ module.name }}')"
                            {% if not rvm_id and module.name == 'tailscale' %}disabled title="RVM ID required first"{% endif %}>
                        Install
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Complete Setup -->
    <section class="section complete-section">
        <div class="complete-panel">
            <h2>Complete Setup</h2>
            <p>You can complete setup after all modules are installed.</p>

            <button class="btn btn-success btn-lg" id="btn-complete"
                    onclick="completeSetup()" disabled>
                Complete Setup
            </button>

            <p class="text-muted mt-2">
                <small>When completed, system will switch to kiosk mode and reboot.</small>
            </p>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/modules.js') }}"></script>
<script>
    // Update progress on page load
    updateProgress();

    // Check MOK status
    checkMokStatus();

    async function checkMokStatus() {
        try {
            const response = await fetch('/api/nvidia/mok-info');
            if (!response.ok) return;

            const data = await response.json();
            const container = document.getElementById('nvidia-mok-info');
            if (!container) return;

            // MOK skipped - driver not working
            if (data.status === 'skipped') {
                container.innerHTML = `
                    <div class="mok-info-box mok-error">
                        <div class="mok-header">‚ö†Ô∏è MOK Skipped - Driver Not Working</div>
                        <div class="mok-content">
                            <p>NVIDIA driver is not signed. You need to re-import MOK.</p>
                            <div class="mok-password">
                                <span>MOK Password:</span>
                                <code>${data.password || '--------'}</code>
                            </div>
                            <div class="mok-steps">
                                <strong>After re-import:</strong>
                                <ol>
                                    <li>System will reboot</li>
                                    <li>Select "Enroll MOK" on blue screen</li>
                                    <li>Enter the password above</li>
                                </ol>
                            </div>
                            <button class="btn btn-warning btn-sm" onclick="reimportMok()">
                                Re-import MOK
                            </button>
                        </div>
                    </div>
                `;
            }
            // MOK pending - waiting for enrollment
            else if (data.status === 'pending') {
                container.innerHTML = `
                    <div class="mok-info-box mok-pending">
                        <div class="mok-header">üîê MOK Enrollment Required</div>
                        <div class="mok-content">
                            <div class="mok-password">
                                <span>MOK Password:</span>
                                <code>${data.password || '--------'}</code>
                            </div>
                            <div class="mok-steps">
                                <strong>After reboot:</strong>
                                <ol>
                                    <li>Select "Enroll MOK" on blue screen</li>
                                    <li>Select "Continue" ‚Üí "Yes"</li>
                                    <li>Enter the password above</li>
                                    <li>Select "Reboot"</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
            }
            // MOK enrolled and NVIDIA working
            else if (data.status === 'enrolled' && data.nvidia_working) {
                container.innerHTML = '';
            }

        } catch (error) {
            console.log('MOK check error:', error);
        }
    }

    async function reimportMok() {
        if (!confirm('MOK will be re-imported and system will reboot. Continue?')) {
            return;
        }

        try {
            const response = await fetch('/api/nvidia/mok-reimport', {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                alert(data.message + '\n\nSystem rebooting...');
                // Reboot
                await fetch('/api/system/reboot', { method: 'POST' });
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('MOK import error: ' + error);
        }
    }
</script>
{% endblock %}
