{% extends "base.html" %}

{% block title %}Install - Kiosk Setup Panel{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Kiosk ID Warning (if not set) -->
    {% if not kiosk_id %}
    <div class="alert alert-warning">
        <strong>Warning:</strong> You must set Kiosk ID from
        <a href="{{ url_for('pages.home') }}">Home</a> before starting installation.
    </div>
    {% endif %}

    <!-- MOK Warning (loaded dynamically) -->
    <div id="mok-alert-container"></div>

    <!-- Installation Modules -->
    <section class="section modules-section">
        <h2 class="section-title">Installation Modules</h2>

        <div class="progress-bar">
            <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
        </div>
        <p class="progress-text" id="progress-text">0 / {{ modules|length }} modules completed</p>

        <div class="modules-list">
            {% for module in modules %}
            {% set status = module_statuses.get(module.name, 'pending') %}
            <div class="module-card" data-module="{{ module.name }}" data-status="{{ status }}">
                <div class="module-order">{{ module.order }}</div>

                <div class="module-info">
                    <h3 class="module-name">{{ module.display_name }}</h3>
                    <p class="module-desc">{{ module.description }}</p>
                    {% if module.dependencies %}
                    <span class="module-deps">Dependency: {{ module.dependencies | join(', ') }}</span>
                    {% endif %}
                </div>

                <div class="module-status">
                    {% if status == 'completed' %}
                    <span class="status-badge success">‚úì Completed</span>
                    {% elif status == 'installing' %}
                    <span class="status-badge warning">‚ü≥ Installing...</span>
                    {% elif status == 'failed' %}
                    <span class="status-badge error">‚úó Error</span>
                    {% elif status == 'reboot_required' %}
                    <span class="status-badge info">‚Üª Reboot Required</span>
                    {% elif status == 'mok_pending' %}
                    <span class="status-badge info">üîê MOK Pending</span>
                    {% else %}
                    <span class="status-badge">Pending</span>
                    {% endif %}

                    {% if module.name == 'nvidia' and status == 'mok_pending' %}
                    <div class="mok-password-info">
                        <strong>MOK Password:</strong>
                        <code class="mok-password">{{ config.get('mok_password', '--------') }}</code>
                        <small>After reboot, select "Enroll MOK" on blue screen and enter this password</small>
                    </div>
                    {% endif %}
                </div>

                <div class="module-actions">
                    {% if status == 'completed' %}
                    <button class="btn btn-secondary" disabled>Installed</button>
                    {% elif status == 'installing' %}
                    <button class="btn btn-secondary" disabled>
                        <span class="spinner"></span> Installing
                    </button>
                    {% elif status == 'reboot_required' or status == 'mok_pending' %}
                    <button class="btn btn-warning btn-reboot" onclick="rebootSystem()">
                        Reboot
                    </button>
                    {% else %}
                    <button class="btn btn-primary btn-install"
                            data-module="{{ module.name }}"
                            onclick="installModule('{{ module.name }}')"
                            {% if not kiosk_id and module.name == 'tailscale' %}disabled title="Kiosk ID required first"{% endif %}>
                        Install
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Complete Setup -->
    <section class="section complete-section">
        <div class="complete-panel">
            <h2>Complete Setup</h2>
            <p>You can complete setup after all modules are installed.</p>

            <button class="btn btn-success btn-lg" id="btn-complete"
                    onclick="completeSetup()" disabled>
                Complete Setup
            </button>

            <p class="text-muted mt-2">
                <small>When completed, system will switch to kiosk mode and reboot.</small>
            </p>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/modules.js') }}"></script>
<script>
    // Update progress on page load
    updateProgress();

    // Check MOK status
    checkMokStatus();

    async function checkMokStatus() {
        try {
            const response = await fetch('/api/nvidia/mok-info');
            if (!response.ok) return;

            const data = await response.json();
            const container = document.getElementById('mok-alert-container');

            // MOK skipped - show warning
            if (data.status === 'skipped') {
                container.innerHTML = `
                    <div class="alert alert-error">
                        <strong>MOK Skipped!</strong>
                        <p>NVIDIA driver is not signed, so it's not working.</p>
                        <p>MOK Password: <code>${data.password || '--------'}</code></p>
                        <button class="btn btn-warning" onclick="reimportMok()">
                            Re-import MOK
                        </button>
                        <small class="d-block mt-1">
                            After import, system will reboot.
                            Select "Enroll MOK" on blue screen and enter the password.
                        </small>
                    </div>
                `;
            }
            // MOK pending - show info
            else if (data.status === 'pending') {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>MOK Pending</strong>
                        <p>When system reboots, select "Enroll MOK" on blue screen.</p>
                        <p>MOK Password: <code>${data.password || '--------'}</code></p>
                        <button class="btn btn-warning" onclick="rebootSystem()">
                            Reboot Now
                        </button>
                    </div>
                `;
            }
            // MOK enrolled and NVIDIA working - success
            else if (data.status === 'enrolled' && data.nvidia_working) {
                // No warning needed, everything is fine
                container.innerHTML = '';
            }

        } catch (error) {
            console.log('MOK check error:', error);
        }
    }

    async function reimportMok() {
        if (!confirm('MOK will be re-imported and system will reboot. Continue?')) {
            return;
        }

        try {
            const response = await fetch('/api/nvidia/mok-reimport', {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                alert(data.message + '\n\nSystem rebooting...');
                // Reboot
                await fetch('/api/system/reboot', { method: 'POST' });
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('MOK import error: ' + error);
        }
    }
</script>
{% endblock %}
